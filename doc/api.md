# TodoList API

## Сушности

UML-диаграмма классов сущностей показана ниже.

![Диаграмма почему-то не показывается](UML_entities_classes.png)


## Формат ошибок

В случае ошибки будет возвращен ответ:

    {
    	"httpCode": 404,
    	"message": "The task with id 3 is not found"
    }

где httpCode - копирует http-код, message - сообщение об ошибке.

## Общие ошибки

При нарушении синтаксиса запроса будет возвращен 400.

При соблюдении синтаксиса и нарушении ограничений на параметры запроса будет возвращен 400.

При ошибке сервера будет возвращен 500.

При несоблюдении прав доступа будет возвращен 403.

## Формат данных

Для взаимодействия используется JSON.

	Content-Type: application/json
	Accept: application/json
	
Любые строки, которые могут быть отправлены клиентом в качестве параметра, имеют ограничение в длину 4096 символов.

Формат времени: ДД-ММ-ГГГГ-ЧЧ-мм-СС (ММ - месяц, мм - минута, ЧЧ - час в 24-часовом формате)

Все указанные далее параметры (в запросе или в теле запроса) обязательны, если не указано иное (например, значение по умолчанию).

## Сортировка

Для методов, у которых указана возможность сортировки результатов, используется параметр sort, который составляется следующим образом:

    X[:asc|desc[,Y[:asc|desc[,...]]]]
    
где X, Y - поля сортировки, asc - сортировка по возрастанию, desc - сортировка по убыванию, если не указывается, то сортируется по возрастанию.

## Фильтрация

Для методов, у которых указана возможность фильтрации, используется параметр filter, который должен содержат в себе выражение в префиксной форме,
с использованием: *=*(равно, при сравнении строк учитывается регистр), *>*(больше), 
*<*(меньше), *>=*(больше или равно), *<=*(меньше или равно), *&*(И), *|*(ИЛИ), *!*(НЕ), 
*like* (только для строк, ищет те строки, которые подходят под шаблон *%string%*, где *%* - любые символы или их отсутствие). Например:
    
    & > update_time 30-11-2020-00-00-01 like name 'Такой-то список дел'.
    
Для булевых значений используется значения *true*/*false* и используется только оператор *=*. Для строковых значений и значений поля *priority*
строки выносятся в одинарные кавычки.
Для экранирования одинарной кавычки используется *\'*
Пробелы между операторами и значениями обязательны. 

## Приоритет

Для заданий и списков используется поле *priority*, которые может принимать следующие значения (от самого низкого к самому высокому): 
"VERY_LOW", "LOW", "MEDIUM", "HIGH", "VERY_HIGH"; регистр игнорируется.

## Аутентификация и авторизация

Для авторизации используются JWT.

Access token: JWT-токен, в payload есть переменные: userId - id пользователя и exp - время истечения токена (количество секунд в эпохе Unix)

Refresh: случайная строка для обновления токенов

Получив access token, необходимо при каждом запросе (кроме тех, где это указано) отправлять заголовок Authorization со значением "Bearer <access token>".

Существует две роли: пользователь и администратор. 
Пользователь может работать только с теми списками и заданиями, что принадлежат ему, и менять только своего пользователя.
Администратор может работать со всеми списками и заданиями. 
 
## Методы

### Аутентификация по логину/паролю

#### POST /auth/login

Authorization не требуется

#### Тело запроса

    {
        "email": "123@mail.com",
        "password": "12345"
    }
    
#### Ответ

Успешная аутентификация: 200

    {
        "accessToken": "<accessToken>",
        "refreshToken": <refreshToken>
    }

Аутентификация провалилась: 401


### Аутентификация по refresh token

#### POST /auth/refresh

Authorization не требуется

#### Тело запроса

    {
        "refreshToken": "<refreshToken>"
    }
    
#### Ответ

Успешная аутентификация: 200

    {
        "accessToken": "<accessToken>",
        "refreshToken": <refreshToken>
    }

Аутентификация провалилась: 401

### Выйти из аккаунта - сбросить refresh token

#### POST /auth/logout

#### Ответ:

Успешно сбросен refresh token - 204


### Получить списки

#### GET /lists

#### Параметры:

**limit** - лимит возвращаемых списков. Принимает значение от 0; при *limit*>100 принимает значение 10. Значение по умолчанию 10.

**sort** - сортировка списков. Поля сортировки: *creation_time*, *update_time*, *name*, *priority*. Значение по умолчанию - сортировка по дате обновления по убыванию.

**filter** - фильтрация списков. Фильтрация происходит по полям *creation_time*, *update_time*, *name*, *priority*. По умолчанию фильтрация не происходит.

**offset** - смещение. Принимает значения от 0. В ответе вернутся листы, которые идут начиная с номера *offset* включительно. По умолчанию 0.

**userId** - id пользователя.

#### Ответ:

Успешно: 200

    {
    	"openedListsCount": 2,
    	"closedListsCount": 3,
    	"totalListsCount": 6
    	"lists": [
    		{
    			"id": 1,
    			"name": "Мой хороший список",
    			"creationTime": "28-09-2020-10-10-59",
    			"updateTime": "29-09-2020-01-23-23",
    			"closed": true,
    			"color": 0б
    			"priority": "VERY_LOW",
    			"userId": 1
    		},
    		...
    	]
    }

*openedListsCount*: количество списков, у которых есть незавершённые задачи.

*closedListsCount*: количество списков, у которых все задачи завершённые.

Если список пустой, то он не включается ни в *openedListsCount*, ни в *closedListsCount*, а соответствующий *closed*=true (это верно и для других методов, 
возвращающих список)

*totalListsCount*: общее число списков в системе вообще.

### Добавить список

#### POST /lists

#### Параметры:

*userId* - id пользователя

#### Тело запроса:

    {
    	"name": "Мой хороший список",
    	"color": 0,
    	"priority": "VERY_LOW"
    }

name должен быть непустой строкой (c учётом *trim*). color может отсутствовать (по умолчанию 0). priority может отсутствовать (по умолчанию VERY_LOW)

#### Ответ: 

Успешно: 201

    {
    	"id": 1,
    	"name": "Мой хороший список",
    	"creationTime": "28-09-2020-23-23-43",
    	"updateTime": "28-09-2020-23-23-43",
    	"closed": true,
    	"color": 0б
    	"priority": "VERY_LOW"б
    	"userId": 1
    }


### Изменить список 

#### PUT /lists/*id*

#### Параметры:

*userId* - id пользователя

#### Тело запроса:

    {
    	"name": "Мой плохой список",
    	"color": 0,
    	"priority": "HIGH"
    }

*name* должен быть непустой строкой (c учётом *trim*). color может отсутствовать (по умолчанию 0). priority может отсутствовать (по умолчанию VERY_LOW)

#### Ответ:

Успешно: 200

    {
    	"id": 1,
    	"name": "Мой плохой список",
    	"creationDate": "28-09-2020-23-23-43",
    	"updateDate": "29-09-2020-13-24-23"б
    	"closed": false,
    	"color": 0,
    	"priority": "HIGH",
    	"userId": 1
    }

Списка *id* не существует: 404.


### Удалить список 

#### DELETE /lists/*id*

#### Параметры:

*userId* - id пользователя

#### Ответ:

Успешно: 204.

Списка *id* не существует: 404.


### Удалить все списки

#### DELETE /lists

#### Параметры:

*userId* - id пользователя

#### Ответ:

Успешно: 204.


### Получить список

#### GET /lists/*id*

#### Параметры

**limit** - лимит возвращаемых дел. Принимает значение от 1; при *limit*>100 принимает значение 10. Значение по умолчанию 10.

**sort** - сортировка дел. Поля сортировки: *creation_time*, *update_time*, *name*, *priority*, *done*, *destination_date*.
Значение по умолчанию - сортировка по дате обновления по убыванию.

**filter** - фильтрация дел. Фильтрация происходит по полям: *creation_time*, *update_time*, *name*, *priority*, *done*, *destination_date*.
По умолчанию фильтрация не происходит.

**offset** - смещение. Принимает значения от 0. В ответе вернутся листы, которые идут начиная с номера *offset* включительно. По умолчанию 0.

*userId* - id пользователя

#### Ответ:

Успешно: 200.

    {
    	"id": 1,
    	"userId": 1,
    	"name": "Мой хороший список",
    	"creationTime": "28-09-2020-00-00-01",
    	"updateTime": "29-09-2020-13-00-23",
    	"closedTasksCount": 1,
    	"openedTasksCount": 2,
    	"totalTasksCount": 5,
    	"closed": false,
    	"color": 0,
    	"priority": "HIGH"
    	"tasks": [
    		{
    			"id": 2,
    			"listId": 1,
    			"userId": 1,
    			"creationTime": "30-11-2020-23-32-44",
    			"updateTime": "01-12-2020-01-23-01",
    			"name": "Написать курсовую",
    			"description": "Необходимо написать курсовую",
    			"priority": "VERY_LOW",
    			"done": true,
    			"destinationDate": "02-12-2020"
    		},
    		...
    	]
    }
    
*closedTasksCount*: количество сделанных задач.

*openedTasksCount*: количество несделанных задач.

*totalTasksCount*: общее количество задач в списке.

Списка *id* не существует: 404.


### Посмотреть дело

#### GET /lists/*listId*/todos/*id*

#### Параметры:

*userId* - id пользователя

#### Ответ:

    {
    	"id": 2,
    	"listId": 1,
    	"userId": 1,
    	"creationTime": "30-11-2020-23-23-23",
    	"updateTime": "30-11-2020-23-23-23",
    	"name": "Написать курсовую",
    	"description": "Необходимо написать курсовую",
    	"priority": "VERY_LOW",
    	"done": false,
    	"destinationDate": "02-12-2020"
    }
    
Списка *listId* или дела *id* не существует: 404.


### Добавить дело

#### POST /lists/*listId*/todos 

#### Параметры:

*userId* - id пользователя

#### Тело запроса:

    {
    	"name": "Написать курсовую",
    	"description": "Эх бы вот написать курсовую",
    	"priority": "VERY_LOW",
    	"destinationDate": "02-12-2020"
    }

*name* должен быть непустой строкой (c учётом *trim*). *description* и *destinationDate* не обязательные параметры.

#### Ответ:

Успешно: 201.

    {
    	"id": 2,
    	"listId": 1,
    	"creationTime": "30-11-2020-23-23-23",
    	"updateTime": "30-11-2020-23-23-23",
    	"name": "Написать курсовую",
    	"description": "Необходимо написать курсовую",
    	"priority": "VERY_LOW",
    	"destinationDate": "02-12-2020",
    	"done": false,
    	"userId": 1
    }

Списка *listId* или дела *id* не существует: 404.


### Изменить дело

#### PUT /lists/*listId*/todos/*id*

#### Параметры:

*userId* - id пользователя

#### Тело запроса:

    {
    	"name": "Написать курсовую",
    	"description": "Необходимо СРОЧНО написать курсовую",
    	"priority": "VERY_LOW",
    	"done": true,
    	"destinationDate": "02-12-2020",
    	"newListId": "2"
    }

*name* должен быть непустой строкой (c учётом *trim*). *description*, *destinationDate*, *newListId* не обязательные параметры. 

#### Ответ:

Успешно: 200.

    {
    	"id": 2,
    	"listId": 2,
    	"creationTime": "30-11-2020-23-23-23",
    	"updateTime": "30-11-2020-23-24-24",
    	"name": "Написать курсовую",
    	"description": "Необходимо написать курсовую",
    	"priority": "LOW",
    	"done": false,
    	"destinationDate": "02-12-2020",
    	"userId": 1
    }

Дело *id* не существует: 404.

Список *listId* не существует: 404.

### Пометить дело как сделанное

#### POST /lists/*listId*/todos/*id*/markDown

#### Параметры:

*userId* - id пользователя

Если дело уже помечено как сделанное, это не будет считаться ошибкой.

#### Ответ:

Успешно: 204

Списка *listId* или дела *id* не существует: 404.


### Удалить дело

#### DELETE /lists/*listId*/todos/*id*

#### Параметры:

*userId* - id пользователя

#### Ответ: 

Успешно: 204.

Списка *listId* или дела *id* не существует: 404.



### Создать пользователя

#### POST /users

#### Тело запроса:

    {
        "email": "123@mail.ru",
        "password": "12345",
        "nickname": "nick",
        "phone": "88005553535",
    }
    
#### Ответ:

Успешно: 201.

    {
        "userId": 3,
        "email": "123@mail.ru",
        "nickname": "nick",
        "phone": "88005553535",
    }
    
### Изменить пользователя

#### PUT /users/*userId*

#### Тело запроса:
    
   
    {
        "email": "123@mail.ru",
        "password": "12345",
        "nickname": "nick",
        "phone": "88005553535",
    }

#### Ответ:

Успешно: 200.

    {
        "userId": 3,
        "email": "123@mail.ru",
        "nickname": "nick",
        "phone": "88005553535",
    }
        
Пользователь не найден: 404.

### Получить пользователя

#### GET /users/*userId*

#### Ответ:

Успешно: 200

    {
        "userId": 3,
        "email": "123@mail.ru",
        "nickname": "nick",
        "phone": "88005553535",
    }
    
Пользователь не найден: 404.

### Получить всех пользователей

#### GET /users

#### Ответ:

Успешно: 200

    {
         "users":   
            [
                    {
                        "userId": 3,
                        "email": "123@mail.ru",
                        "nickname": "nick",
                        "phone": "88005553535",
                    }
            ]
    }
    
### Удалить пользователя

#### DELETE /users/*userId*

#### Ответ:

Успешно: 204.

Пользователь не найден: 404


### Аутентификация

#### POST /auth

#### Тело запроса

    {
        "email": "email@mail.com",
        "password": "12345"
    }
    
#### Ответ:

Если совпадают: 200

    {
        "success": true,
        "userId": 1
    }
    
Если не совпадают: 200

    {
        "success:" false,
        "userId": null
    }